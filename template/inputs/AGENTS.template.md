# AIエージェント向け指示（汎用版 v2）

> 目的: LLM/AI を含むアプリケーション開発において、要求定義〜テストまでを一貫した秩序で進めるための普遍的ガイド。
> 適用範囲: 単一/複数リポジトリ、任意の言語/フレームワーク/クラウドに適用可能。

## 相談の仕方
- 提案は**鵜呑みにせず検証**する。懸念点があれば明示し、可能なら代替案を提示する。
- 回答時は **セキュリティ / パフォーマンス / ユーザー体験(UX) / アクセシビリティ / トレーサビリティ(可観測性・説明責任)** を重視する。
- 重要判断の根拠（データ・規約・計測値・既知のベストプラクティス）を必ず示す。

## 開発プロセス（要求駆動・モデル駆動）
- フロー: **要求 → シナリオ → 要件 → 概念モデル → ユースケース図 → 仕様 → 設計 → 実装 → テスト**
- 各段階で完成条件(Definition of Done)とレビュー観点を定義し、合意なく次段階へ進まない。
- 図は **mermaid** で記述（https://mermaid.js.org/ を参照）。  
- 変更は **ADR** (Architecture Decision Record) に記録し、履歴と影響範囲を明記する。

### 優先度・整合性
- 優先度: **要求 > シナリオ > 要件 > ユースケース > 仕様 > 設計 > 実装 = テスト**。
- 下位成果物は上位と**矛盾してはならない**。上位が更新されたら下位も**必ず追従**。
- 矛盾が発生/予見される場合は、**修正方針をADRで確定**してから実施。

## 用語と成果物配置（パスは可変）
- ルートは `<REPO_ROOT>`。単一/複数リポジトリでも同一規約で配置する。集約リポジトリを使う場合は `<GOV_REPO>` を別途定義。
  - 要求: `<REPO_OR_GOV>/docs/requests/{title}.md`
  - シナリオ: `<REPO_OR_GOV>/docs/scenario/{title}.md`
  - 要件: `<REPO_OR_GOV>/docs/requirements/{title}.md`
  - ユースケース: `<REPO_OR_GOV>/docs/usecases/{title}.md`
  - 仕様: `<REPO_OR_GOV>/docs/spec/{title}.md`
  - 設計: `<REPO_OR_GOV>/docs/design/{title}.md`
  - ADR: `<REPO_OR_GOV>/docs/adr/{yyyymmdd}-{slug}.md`

### モデル（図）の定義
- モデルとは、対象の詳細を省き**利用者に必要な情報のみ**を示す図。  
- 依頼時に**「誰のためのモデルか」**を必ず明記（例: 利用者/開発者/運用者/法務/経営）。

### 要求
- アプリを通じて実現したい事項。各要求は **5W1H** を持つ。  
- 要求は**推測で加筆しない**。必ずステークホルダー確認のうえ編集。  
- 各要求に**優先順位**と**検証可能な受入基準**（例: 具体的な観測指標）を付す。

### シナリオ
- 代表的な利用フロー（誰が／何を使い／何を達成するか）。詳細な内部制限や実装は記さない。
- 先行/後続のシナリオ依存は明示。アクター×ユースケースのみで図示可。
- 各シナリオは対応する要求を明記。

### 要件
- 共通語彙で全体像を合意するための記述。  
- 記載事項: **ユーザー種別 / 情報構造(概念) / 提供機能 / 機能によって実現される価値**。  
- 要件ドキュメントには**概念モデル**（ユーザーと開発者向け）を含む。  
- 各要件は対応するシナリオを明記。

### ユースケース
- シナリオ・要件から **アクター / ユースケース / エンティティ / バウンダリ / コントロール**を抽出。
- 各ユースケースに **事前条件 / 事後条件** を付す。  
- 外部システム連携は**外部アクター**として明示（外部であることも表示）。  
- 全体を俯瞰する**ユースケース図**を含む。
- 各ユースケースは対応する要件を明記。

### 仕様
- ユースケースから**具体的な機能定義**を行う。  
- 各仕様には以下を含める:  
  - **公開操作（API/UI）**  
  - **入力要件**（ユーザー/クライアントが提供すべき情報、検証ルール）  
  - **出力契約**（アプリが返す情報、状態変化、非機能保証があれば記載）  
  - **制限事項**（なければ「無し」）  
  - 必要に応じて**レート制限・エラーモデル・監査ログ要件**  
- 仕様には**仕様モデル**（ユーザー＋開発者向け）を含む。

### 設計
- 仕様を満たすモジュール構成・依存・配置。  
- 原則: **可読性 / 交換容易性 / 一覧性**、**低結合・高凝集**。  
- パラダイムは**状況適応**（OOP/FPの原理主義を避ける）。  
- 設計ドキュメントに**実装モデル（クラス図等）**を含む。対応する仕様を明記。

## AI/LLM 特有の要件（技術非依存）
- **プロンプト/ポリシー管理**: 版管理・差分・監査ログ・ロールバック方針。
- **モデル選定/切替**: 目的別のモデル基準（品質/コスト/遅延/地域・データ越境/可用性）、フェイルオーバー戦略。
- **評価/回帰**: 自動/半自動の**モデル評価**（品質指標、毒性/偏り、安全性、再現テストデータ）、**回帰防止**基準。
- **データ方針**: 入出力の機微情報(PII/PHI等)の**遮蔽/匿名化/保持期間/持ち出し禁止**。  
- **安全策**: レート制限、出力フィルタ、脱線検知(guardrails)、プロンプト注入耐性、機密/権限境界の明示。

## テスト（ツール非依存）
- 階層: **単体 / 統合 / 契約 / e2e / 回帰 / 性能 / セキュリティ / アクセシビリティ**。  
- **Property-based testing を優先検討**。困難領域は **サンプルベース**で補完。  
- e2e は**独立パッケージ/独立ジョブ**で実行。  
- LLM評価は**自動指標＋人的評価**を組み合わせ、**再評価可能なベンチ**を保持。

## 可観測性・追跡性（Observability）
- すべての外部公開機能に**構造化ログ / メトリクス / トレース**を付与。相関IDで連結。  
- **監査ログ**（誰が・何を・いつ・どのリソースに）を記録。保持/マスキング/開示フローを定義。
- 障害時は**事後分析(ブレームレス・ポストモーテム)**を ADR と連携して残す。

## セキュリティ・プライバシー・コンプライアンス
- **脅威モデリング**を要求/要件段階で実施（STRIDE 等の方式は任意）。  
- 秘密情報は**セcrets管理**を用い、ローカルやコードに直置きしない。鍵は**ローテーション可能**とする。  
- 依存の**ライセンス/脆弱性スキャン**と**SBOM**生成を定期実施。  
- データは**分類(機微/非機微)**し、**保存最小化・暗号化・最小権限**を徹底。  
- 適用法令/規約（個人情報/越境/業界規制）を**要件として明文化**。

## アクセシビリティ / 国際化
- 早期に**アクセシビリティ要件**（目標適合度、キーボード操作、コントラスト、代替テキスト等）を定義。  
- 国際化が関係する場合は**言語/地域/書式/時区間**要件を明記。

## インフラ・運用（技術選定の原則）
- 原則は **コスト最小化 / 信頼性 / 可搬性 / 運用容易性**。具体のクラウド/製品名は拘束しない。  
- データストア/ORM/移行ツールは**スキーマ管理・移行計画・ロールバック**を必須要件とする。  
- ランタイム/ホスティングに依存しない**ヘルスチェック / デプロイ戦略(Blue-Green/Canary) / ロールバック手順**を定義。

## 依存更新（Bot等の自動化を含む）
- 自動更新ブランチからのPRは**スタックPR**を推奨（main 直は避ける）。  
- **緊急脆弱性**は例外ルールで直ちにパッチ、影響と回避策を ADR に記録。

## Pull Request 作成・更新
- 作成前: ベースブランチ確認→更新→差分があれば**rebase**→コンフリクトは**解決内容をコミットログに記録**。  
- 更新前: リモート追従→コンフリクト解決。  
- PRは**関連ドキュメント（要求〜仕様）への追従**をチェック項目化（テンプレに含める）。

## リリースノート
- リポジトリ/プラットフォームの**自動生成**を原則とする（ツールは問わない）。  
- 重要変更（破壊的/移行手順/制約変更）は**手動で追記**して明確化。

